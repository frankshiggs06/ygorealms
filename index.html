<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Duelistas - Yu-Gi-Oh!</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Fondo oscuro */
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: #2d3748; /* Color de tarjeta oscuro */
        }
        .header-bg {
            background-color: #3182ce; /* Azul vibrante */
        }
        .dp-score {
            text-shadow: 0 0 5px #f6e05e;
        }
        
        /* Estilos para feedback */
        .feedback-message {
            transition: opacity 0.5s ease-out;
        }
        /* Estilos para el modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 1.5rem; /* p-6 */
            width: 100%;
            max-width: 32rem; /* max-w-lg */
            border: 1px solid #374151; /* gray-700 */
        }

        /* Estilo para las im谩genes de los packs */
        .pack-image {
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-bottom: 0.75rem;
            border: 2px solid #4a5568; /* Borde gris */
        }

        /* --- NUEVOS ESTILOS PARA JUEGOS --- */
        .game-card {
            background-color: #374151; /* gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 2px solid #4b5563; /* gray-600 */
            transition: all 0.3s ease;
        }
        .game-card:not(.disabled) {
            cursor: pointer;
        }
        .game-card:not(.disabled):hover {
            border-color: #ec4899; /* pink-500 */
            transform: translateY(-5px);
        }
        .game-card.disabled {
            opacity: 0.5;
            background-color: #1f2937; /* gray-800 */
        }
        .game-card-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
        }
        .game-card-description {
            font-size: 0.875rem; /* text-sm */
            color: #9ca3af; /* gray-400 */
            margin-top: 0.5rem; /* mt-2 */
            margin-bottom: 1rem; /* mb-4 */
            flex-grow: 1;
        }
        
        /* Estilos para el juego Eternals BetCards */
        #game-1-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .bet-card {
            aspect-ratio: 2.5 / 3.5;
            background-color: #4b5563; /* gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
        }
        .bet-card:hover {
            border-color: #fcd34d; /* yellow-300 */
        }
        .bet-card .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }
        .bet-card .card-front {
            /* Patr贸n de dorso de carta Yu-Gi-Oh! (simplificado) */
            background-color: #1e3a8a; /* blue-800 */
            background-image: radial-gradient(#fcd34d 20%, transparent 20%),
                              radial-gradient(#fcd34d 20%, transparent 20%);
            background-position: 0 0, 50px 50px;
            background-size: 10px 10px;
        }
        .bet-card .card-back {
            transform: rotateY(180deg);
        }
        .bet-card .card-back.win {
            background-color: #ca8a04; /* yellow-600 */
            color: #1f2937;
            border: 2px solid #fde047; /* yellow-200 */
        }
        .bet-card .card-back.lose {
            background-color: #374151; /* gray-700 */
            color: #9ca3af;
            border: 2px solid #4b5563; /* gray-600 */
        }

        .bet-card.is-flipped {
            transform: rotateY(180deg);
        }
        .bet-card.chosen {
            border-color: #22c55e; /* green-500 */
            box-shadow: 0 0 20px #22c55e;
        }

        /* Estilos para botones de apuesta */
        .bet-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: #374151; /* gray-700 */
            border: 2px solid #4b5563; /* gray-600 */
            color: #d1d5db; /* gray-300 */
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .bet-button:hover:not(:disabled) {
            background-color: #4b5563; /* gray-600 */
        }
        .bet-button.selected {
            background-color: #3b82f6; /* blue-600 */
            border-color: #60a5fa; /* blue-400 */
            color: white;
            box-shadow: 0 0 10px #3b82f6;
        }
        .bet-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Estilos Juego 2: Duelo de Dados */
        #game-2-dice-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            min-height: 80px;
        }
        .dice {
            width: 80px;
            height: 80px;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        /* Estilos Juego 3: Moneda */
        #game-3-coin {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 1.5rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            background-color: #fbbf24; /* amber-400 */
            border: 5px solid #f59e0b; /* amber-500 */
            transition: transform 0.5s;
        }

    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Pantalla de Inicio de Sesi贸n (Se muestra al inicio) -->
    <div id="login-screen" class="modal-overlay flex">
        <div class="card p-6 rounded-xl text-white w-full max-w-sm">
            <h2 class="text-3xl font-extrabold mb-6 text-center text-yellow-400">Iniciar Sesi贸n</h2>
            <div class="space-y-4">
                <div>
                    <label for="login-username" class="block text-sm font-medium text-gray-300 mb-2">Nombre de Usuario:</label>
                    <input type="text" id="login-username" placeholder="Tu nombre de duelista" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Contrase帽a:</label>
                    <input type="password" id="login-password" placeholder="Tu contrase帽a" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Entrar al Torneo
                </button>
                <p id="login-feedback" class="text-red-400 text-sm h-5 text-center"></p>
                <p id="db-loading-feedback" class="text-yellow-300 text-sm h-5 text-center">Conectando a la base de datos...</p>
            </div>
        </div>
    </div>

    <!-- Contenido principal de la aplicaci贸n (oculto por defecto) -->
    <div id="app-content" class="hidden">

        <!-- Encabezado Fijo y Navegaci贸n -->
        <header class="header-bg p-4 rounded-lg mb-8 shadow-xl text-white">
            <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold tracking-tight mb-2 sm:mb-0">
                    Torneo de Duelistas 
                </h1>
                <nav class="space-x-4">
                    <a href="#usuarios" class="hover:text-gray-200 transition duration-150 font-medium">Usuarios</a>
                    <a href="#packs" class="hover:text-gray-200 transition duration-150 font-medium">Packs</a>
                    <a href="#ranking" class="hover:text-gray-200 transition duration-150 font-medium">Ranking</a>
                    <a href="#admin" class="hover:text-gray-200 transition duration-150 font-medium">Admin</a>
                    <a href="#juegos" class="hover:text-gray-200 transition duration-150 font-medium">Juegos</a>
                    <a href="#historia" class="hover:text-gray-200 transition duration-150 font-medium">Historia</a>
                </nav>
            </div>
            <!-- Muestra Usuario -->
            <div class="max-w-6xl mx-auto text-center mt-2 space-y-1">
                <span class="text-xs text-gray-200 block">Usuario Conectado: <strong id="logged-in-user-display" class="font-mono text-yellow-300">Ninguno</strong></span>
            </div>
        </header>

        <main class="max-w-6xl mx-auto space-y-12">

            <!-- Secci贸n 1: Usuarios (Tabla de Puntos DP) -->
            <section id="usuarios" class="card p-6 rounded-xl text-white">
                <h2 class="text-3xl font-extrabold mb-6 text-yellow-400 border-b border-yellow-400/50 pb-2">
                     Usuarios y Puntuaci贸n DP
                </h2>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-600">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                                    Jugador
                                </th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                                    Puntos DP
                                </th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-300">
                                    Deck Inicial
                                </th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="3" class="px-4 py-4 text-center text-gray-400">Cargando jugadores...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <p class="mt-6 text-sm text-gray-400">
                    *Los Puntos DP (Duelist Points) se usan para adquirir nuevos packs y mejorar tu colecci贸n.
                </p>
            </section>

            <!-- Secci贸n 2: Packs (Tienda/Adquisici贸n) -->
            <section id="packs" class="card p-6 rounded-xl text-white">
                <h2 class="text-3xl font-extrabold mb-6 text-blue-400 border-b border-blue-400/50 pb-2">
                     Packs de Cartas
                </h2>
                
                <div class="mb-6">
                    <p class="text-lg text-gray-300">Est谩s comprando como: <strong id="pack-buyer-display" class="text-yellow-300">...</strong></p>
                    <p id="purchase-feedback" class="text-yellow-300 text-sm mt-2 h-5 feedback-message opacity-0"></p>
                </div>

                <!-- Contenedor de Grid para los packs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Pack 1: Poder del Mago (Yugi/Pegasus) -->
                    <div class="bg-gray-700 p-4 rounded-lg border-2 border-gray-600 hover:border-purple-500 transition duration-300 flex flex-col">
                        <img src="https://placehold.co/300x300/6b21a8/ffffff?text=Poder+del+Mago" alt="Poder del Mago" class="pack-image">
                        <h3 class="text-xl font-bold mb-2 text-purple-300">Poder del Mago</h3>
                        <p class="text-3xl font-extrabold text-yellow-400 mb-3">150 DP</p>
                        <ul class="text-sm space-y-1 text-gray-400 flex-grow">
                            <li>Contiene 5 Cartas.</li>
                            <li>Soporte para Decks de Hechiceros y Rituales.</li>
                            <li>Ideal para Yugi y Pegasus.</li>
                        </ul>
                        <button id="buy-pack-1" data-cost="150" data-name="Poder del Mago" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50">
                            Comprar (150 DP)
                        </button>
                    </div>
                    
                    <!-- Pack 2: Furia del Drag贸n (Kaiba/Joey) -->
                    <div class="bg-gray-700 p-4 rounded-lg border-2 border-gray-600 hover:border-blue-500 transition duration-300 flex flex-col">
                        <img src="https://placehold.co/300x300/1d4ed8/ffffff?text=Furia+del+Drag贸n" alt="Furia del Drag贸n" class="pack-image">
                        <h3 class="text-xl font-bold mb-2 text-blue-300">Furia del Drag贸n</h3>
                        <p class="text-3xl font-extrabold text-yellow-400 mb-3">150 DP</p>
                        <ul class="text-sm space-y-1 text-gray-400 flex-grow">
                            <li>Contiene 5 Cartas.</li>
                            <li>Soporte para Decks de Dragones y Guerreros.</li>
                            <li>Ideal para Kaiba y Joey.</li>
                        </ul>
                        <button id="buy-pack-2" data-cost="150" data-name="Furia del Drag贸n" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50">
                            Comprar (150 DP)
                        </button>
                    </div>

                    <!-- Pack 3: Arsenal del Duelista (Staples) -->
                    <div class="bg-gray-700 p-4 rounded-lg border-2 border-gray-600 hover:border-yellow-500 transition duration-300 flex flex-col">
                        <img src="https://placehold.co/300x300/ca8a04/ffffff?text=Arsenal+del+Duelista" alt="Arsenal del Duelista" class="pack-image">
                        <h3 class="text-xl font-bold mb-2 text-yellow-300">Arsenal del Duelista</h3>
                        <p class="text-3xl font-extrabold text-yellow-400 mb-3">300 DP</p>
                        <ul class="text-sm space-y-1 text-gray-400 flex-grow">
                            <li>Contiene 5 Cartas.</li>
                            <li>Cartas "Staple" gen茅ricas de Magia/Trampa.</li>
                            <li>Garantiza 1 S煤per Rara.</li>
                        </ul>
                        <button id="buy-pack-3" data-cost="300" data-name="Arsenal del Duelista" class="mt-4 w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50">
                            Comprar (300 DP)
                        </button>
                    </div>

                    <!-- PACK 4: Tesoro del Fara贸n (Alto Riesgo) -->
                    <div class="bg-gray-700 p-4 rounded-lg border-2 border-gray-600 hover:border-amber-300 transition duration-300 flex flex-col">
                        <img src="https://placehold.co/300x300/a16207/ffffff?text=Tesoro+del+Fara贸n" alt="Tesoro del Fara贸n" class="pack-image">
                        <h3 class="text-xl font-bold mb-2 text-amber-300">Tesoro del Fara贸n</h3>
                        <p class="text-3xl font-extrabold text-yellow-400 mb-3">500 DP</p>
                        <ul class="text-sm space-y-1 text-gray-400 flex-grow">
                            <li>Contiene 5 Cartas.</li>
                            <li>Alto riesgo, alta recompensa.</li>
                            <li>Posibilidad de Staples de poder (SR) o cartas "Exodia".</li>
                        </ul>
                        <button id="buy-pack-4" data-cost="500" data-name="Tesoro del Fara贸n" class="mt-4 w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50">
                            Comprar (500 DP)
                        </button>
                    </div>

                    <!-- PACK 5: Legado del Ojo Azul (Poder Kaiba) -->
                    <div class="bg-gray-700 p-4 rounded-lg border-2 border-gray-600 hover:border-cyan-300 transition duration-300 flex flex-col">
                        <img src="https://placehold.co/300x300/0e7490/ffffff?text=Legado+del+Ojo+Azul" alt="Legado del Ojo Azul" class="pack-image">
                        <h3 class="text-xl font-bold mb-2 text-cyan-300">Legado del Ojo Azul</h3>
                        <p class="text-3xl font-extrabold text-yellow-400 mb-3">1000 DP</p>
                        <ul class="text-sm space-y-1 text-gray-400 flex-grow">
                            <li>Contiene 7 Cartas.</li>
                            <li>Cartas de poder enfocadas en Dragones y M谩quinas.</li>
                            <li>Garantiza 2 S煤per Raras.</li>
                        </ul>
                        <button id="buy-pack-5" data-cost="1000" data-name="Legado del Ojo Azul" class="mt-4 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50">
                            Comprar (1000 DP)
                        </button>
                    </div>

                    <!-- PACK 6: El Cofre Prohibido (Definitivo) -->
                    <div class="bg-gray-700 p-4 rounded-lg border-2 border-gray-600 hover:border-red-500 transition duration-300 flex flex-col">
                        <img src="https://placehold.co/300x300/b91c1c/ffffff?text=El+Cofre+Prohibido" alt="El Cofre Prohibido" class="pack-image">
                        <h3 class="text-xl font-bold mb-2 text-red-300">El Cofre Prohibido</h3>
                        <p class="text-3xl font-extrabold text-yellow-400 mb-3">1500 DP</p>
                        <ul class="text-sm space-y-1 text-gray-400 flex-grow">
                            <li>Contiene 7 Cartas.</li>
                            <li>Solo contiene cartas Raras, S煤per Raras y Ultra Raras.</li>
                            <li>Garantiza 1 Ultra Rara.</li>
                        </ul>
                        <button id="buy-pack-6" data-cost="1500" data-name="El Cofre Prohibido" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50">
                            Comprar (1500 DP)
                        </button>
                    </div>

                </div>
            </section>

            <!-- Ranking Semanal -->
            <section id="ranking" class="card p-6 rounded-xl text-white">
                <h2 class="text-3xl font-extrabold mb-6 text-green-400 border-b border-green-400/50 pb-2">
                     Ranking Semanal
                </h2>
                <p class="text-gray-300 mb-6">Jugadores ordenados por victorias esta semana (Lunes a Domingo).</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-600">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-300">Pos.</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-300">Jugador</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-300">Victorias Semanales</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-table-body" class="divide-y divide-gray-700">
                            <tr><td colspan="3" class="px-4 py-4 text-center text-gray-400">Cargando ranking...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Panel de Administraci贸n -->
            <section id="admin" class="card p-6 rounded-xl text-white">
                <h2 class="text-3xl font-extrabold mb-6 text-indigo-400 border-b border-indigo-400/50 pb-2">
                    锔 Panel de Administraci贸n
                </h2>

                <!-- Bloqueo de Contrase帽a -->
                <div id="admin-lock-screen" class="space-y-4 text-center p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                    <label for="admin-password" class="block text-lg font-medium text-gray-300 mb-2">Se requiere contrase帽a de administrador:</label>
                    <input type="password" id="admin-password" placeholder="Contrase帽a" class="w-full max-w-sm mx-auto bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="admin-unlock-button" class="w-full max-w-sm mx-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300" disabled>
                        Desbloquear
                    </button>
                    <p id="admin-lock-feedback" class="text-red-400 text-sm mt-2 h-5"></p>
                    <p class="text-xs text-gray-400">Debes iniciar sesi贸n como usuario primero.</p>
                </div>

                <!-- Contenido del Admin (oculto por defecto) -->
                <div id="admin-content" class="hidden">
                    <!-- Formulario para Registrar Duelos -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <h3 class="text-xl font-bold mb-3 text-gray-100">Registrar Duelo</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="admin-player-select" class="block text-sm font-medium text-gray-300 mb-2">Ganador:</label>
                                    <select id="admin-player-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option>Cargando...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="admin-player-select-loser" class="block text-sm font-medium text-gray-300 mb-2">Perdedor:</label>
                                    <select id="admin-player-select-loser" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option>Cargando...</option>
                                    </select>
                                </div>
                                <div class="flex items-center">
                                    <input id="admin-surrender-checkbox" type="checkbox" class="h-4 w-4 bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500 rounded">
                                    <label for="admin-surrender-checkbox" class="ml-2 block text-sm text-gray-300">
                                        El perdedor se rindi贸 (Surrender)
                                    </label>
                                </div>
                                <p class="text-xs text-gray-400 -mt-2 ml-6">(+50 DP extra al ganador, -50 DP al perdedor)</p>
                                
                                <div class="flex items-center">
                                    <input id="admin-flawless-checkbox" type="checkbox" class="h-4 w-4 bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500 rounded">
                                    <label for="admin-flawless-checkbox" class="ml-2 block text-sm text-gray-300">
                                        Ganador no perdi贸 LP (Flawless)
                                    </label>
                                </div>
                                <p class="text-xs text-gray-400 -mt-2 ml-6">(+100 DP extra al ganador)</p>

                                <button id="admin-submit-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mt-4">
                                    Registrar Duelo
                                </button>
                            </div>
                        </div>
                        
                        <!-- Formulario para A帽adir Nuevo Jugador -->
                        <div>
                            <h3 class="text-xl font-bold mb-3 text-gray-100">A帽adir Nuevo Jugador</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="admin-new-player-name" class="block text-sm font-medium text-gray-300 mb-2">Nombre:</label>
                                    <input type="text" id="admin-new-player-name" placeholder="Nombre del Duelista" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="admin-new-player-deck" class="block text-sm font-medium text-gray-300 mb-2">Deck Inicial:</label>
                                    <select id="admin-new-player-deck" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option>Yugi</option>
                                        <option>Kaiba</option>
                                        <option>Joey</option>
                                        <option>Pegasus</option>
                                        <option>Otro</option>
                                    </select>
                                </div>
                                <button id="admin-add-player-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                    A帽adir Jugador
                                </button>
                            </div>
                        </div>
                    </div>
                    <p id="admin-feedback" class="text-center text-yellow-300 text-sm mt-2 h-5 feedback-message opacity-0"></p>

                    <!-- Gesti贸n Semanal -->
                    <hr class="border-gray-600 my-8">
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-gray-100">Gesti贸n Semanal</h3>
                        <p class="text-sm text-gray-400 mb-4">
                            Al cerrar la semana, se anunciar谩 al ganador en la historia y se reiniciar谩n todas las victorias semanales a 0.
                        </p>
                        <button id="admin-reset-week-button" class="w-full max-w-sm mx-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                            Cerrar Semana y Reiniciar Ranking
                        </button>
                        <p id="admin-week-feedback" class="text-center text-yellow-300 text-sm mt-2 h-5 feedback-message opacity-0"></p>
                    </div>

                    <!-- Inventario de Cartas Adquiridas -->
                    <hr class="border-gray-600 my-8">
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-gray-100">Inventario de Cartas</h3>
                        <p class="text-sm text-gray-400 mb-4">
                            Selecciona un jugador para ver todas las cartas que ha adquirido en los packs.
                        </p>
                        <div>
                            <label for="admin-card-inventory-select" class="block text-sm font-medium text-gray-300 mb-2">Seleccionar Jugador:</label>
                            <select id="admin-card-inventory-select" class="w-full max-w-sm bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option>Cargando...</option>
                            </select>
                        </div>
                        
                        <h4 class="text-lg font-semibold mt-6 mb-3 text-gray-200">Colecci贸n:</h4>
                        <ul id="admin-card-inventory-list" class="space-y-2 bg-gray-900 p-4 rounded-lg border border-gray-600 min-h-[150px] max-h-60 overflow-y-auto">
                            <li class="text-gray-400">Selecciona un jugador para ver su inventario.</li>
                        </ul>
                    </div>

                </div>
            </section>
            
            <!-- SECCIN DE JUEGOS (MODIFICADA) -->
            <section id="juegos" class="card p-6 rounded-xl text-white">
                <h2 class="text-3xl font-extrabold mb-6 text-pink-400 border-b border-pink-400/50 pb-2">
                     Sala de Juegos (Apuestas DP)
                </h2>
                <p class="text-gray-300 mb-6">
                    驴Te sientes con suerte, duelista? Cada juego se puede jugar 3 veces al d铆a. El l铆mite se reinicia 24 horas despu茅s de tu primera partida.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Juego 1: Eternals BetCards (Activo) -->
                    <div id="open-game-1" class="game-card">
                        <div>
                            <h3 class="game-card-title text-pink-300">Eternals BetCards</h3>
                            <p class="game-card-description">
                                1 de 3 cartas gana (1.5x).
                            </p>
                        </div>
                        <button id="game-1-button" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50" disabled>
                            <span id="game-1-button-text">Jugar (3/3 Oportunidades)</span>
                        </button>
                    </div>

                    <!-- Juego 2: Duelo de Dados (Activo) -->
                    <div id="open-game-2" class="game-card">
                        <div>
                            <h3 class="game-card-title text-green-300">Duelo de Dados</h3>
                            <p class="game-card-description">
                                Apuesta al resultado de 2 dados. (< 7 = 2x, = 7 = 5x, > 7 = 2x).
                            </p>
                        </div>
                        <button id="game-2-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50" disabled>
                            <span id="game-2-button-text">Jugar (3/3 Oportunidades)</span>
                        </button>
                    </div>
                    
                    <!-- Juego 3: La Moneda del Milenio (Activo) -->
                    <div id="open-game-3" class="game-card">
                        <div>
                            <h3 class="game-card-title text-yellow-300">Moneda del Milenio</h3>
                            <p class="game-card-description">
                                Un simple 50/50. Ganas 1.9x (la casa cobra 10% de comisi贸n).
                            </p>
                        </div>
                        <button id="game-3-button" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50" disabled>
                            <span id="game-3-button-text">Jugar (3/3 Oportunidades)</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Historia de Eventos -->
            <section id="historia" class="card p-6 rounded-xl text-white">
                <h2 class="text-3xl font-extrabold mb-6 text-green-400 border-b border-green-400/50 pb-2">
                     Historia de Puntos y Eventos
                </h2>
                <p class="text-gray-300 mb-6">Registro de todos los cambios importantes en el progreso de los duelistas (en tiempo real).</p>

                <ul id="history-list" class="space-y-4">
                    <li class="bg-gray-700 p-3 rounded-lg text-center text-gray-400">Cargando historial...</li>
                </ul>
            </section>

        </main>

        <!-- Modal de Apertura de Pack -->
        <div id="pack-opening-modal" class="modal-overlay hidden opacity-0 visibility-hidden">
            <div class="modal-content">
                <h3 class="text-2xl font-bold mb-4 text-center text-yellow-300">隆Pack Adquirido!</h3>
                <p class="text-center text-gray-400 text-sm mb-4">隆Estas son las cartas que obtuviste! (Nombres en Ingl茅s para YGOPro):</p>
                
                <ul id="pack-card-list" class="space-y-2 bg-gray-900 p-4 rounded-lg border border-gray-600 mb-6 min-h-[150px]">
                    <!-- Las cartas se insertar谩n aqu铆 din谩micamente -->
                </ul>
                
                <button id="modal-close-pack-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Aceptar
                </button>
            </div>
        </div>

        <!-- --- MODALES DE JUEGOS --- -->

        <!-- Modal de Juego 1: Eternals BetCards -->
        <div id="game-1-modal" class="modal-overlay hidden opacity-0 visibility-hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-center text-pink-300">Eternals BetCards</h3>
                    <button id="game-1-close-button" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                </div>
                
                <!-- Paso 1: Seleccionar Apuesta -->
                <div id="game-1-step-1">
                    <p class="text-center text-gray-300 mb-4">Selecciona tu apuesta. 1 de 3 cartas es la ganadora (Premio: 1.5x).</p>
                    <div id="game-1-bet-options" class="flex justify-center gap-2 flex-wrap mb-4">
                        <button class="bet-button" data-bet="50">50 DP</button>
                        <button class="bet-button" data-bet="100">100 DP</button>
                        <button class="bet-button" data-bet="150">150 DP</button>
                        <button class="bet-button" data-bet="200">200 DP</button>
                        <button class="bet-button" data-bet="500">500 DP</button>
                    </div>
                </div>

                <!-- Paso 2: Elegir Carta -->
                <div id="game-1-step-2" class="hidden">
                    <p class="text-center text-gray-300 mb-4">隆Apuesta seleccionada! Ahora, elige tu carta. 隆Suerte!</p>
                </div>

                <!-- El Juego -->
                <div id="game-1-grid" class="opacity-50 pointer-events-none">
                    <div class="bet-card" data-index="0">
                        <div class="card-face card-front"></div>
                        <div class="card-face card-back"></div>
                    </div>
                    <div class="bet-card" data-index="1">
                        <div class="card-face card-front"></div>
                        <div class="card-face card-back"></div>
                    </div>
                    <div class="bet-card" data-index="2">
                        <div class="card-face card-front"></div>
                        <div class="card-face card-back"></div>
                    </div>
                </div>
                <p id="game-1-feedback" class="text-center text-yellow-300 h-5 mt-4"></p>
            </div>
        </div>
        
        <!-- Modal de Juego 2: Duelo de Dados -->
        <div id="game-2-modal" class="modal-overlay hidden opacity-0 visibility-hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-center text-green-300">Duelo de Dados</h3>
                    <button id="game-2-close-button" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                </div>
                
                <div id="game-2-step-1">
                    <p class="text-center text-gray-300 mb-4">Selecciona tu apuesta base:</p>
                    <div id="game-2-bet-options" class="flex justify-center gap-2 flex-wrap mb-4">
                        <button class="bet-button" data-bet="50">50 DP</button>
                        <button class="bet-button" data-bet="100">100 DP</button>
                        <button class="bet-button" data-bet="150">150 DP</button>
                    </div>
                </div>

                <div id="game-2-step-2" class="hidden">
                    <p class="text-center text-gray-300 mb-4">Apuesta: <span id="game-2-bet-display" class="font-bold text-white">0</span> DP. 驴Cu谩l ser谩 el resultado?</p>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button id="game-2-choice-low" class="bet-button text-lg py-3">Menor que 7 (x2)</button>
                        <button id="game-2-choice-seven" class="bet-button text-lg py-3">Igual a 7 (x5)</button>
                        <button id="game-2-choice-high" class="bet-button text-lg py-3">Mayor que 7 (x2)</button>
                    </div>
                </div>
                
                <div id="game-2-dice-container">
                    <div id="game-2-dice-1" class="dice">?</div>
                    <div id="game-2-dice-2" class="dice">?</div>
                </div>
                
                <p id="game-2-feedback" class="text-center text-yellow-300 h-5 mt-4"></p>
            </div>
        </div>

        <!-- Modal de Juego 3: Moneda del Milenio -->
        <div id="game-3-modal" class="modal-overlay hidden opacity-0 visibility-hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-center text-yellow-300">Moneda del Milenio</h3>
                    <button id="game-3-close-button" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                </div>
                
                <div id="game-3-step-1">
                    <p class="text-center text-gray-300 mb-4">Selecciona tu apuesta (Premio: 1.9x):</p>
                    <div id="game-3-bet-options" class="flex justify-center gap-2 flex-wrap mb-4">
                        <button class="bet-button" data-bet="50">50 DP</button>
                        <button class="bet-button" data-bet="100">100 DP</button>
                        <button class="bet-button" data-bet="150">150 DP</button>
                    </div>
                </div>

                <div id="game-3-step-2" class="hidden">
                    <p class="text-center text-gray-300 mb-4">Apuesta: <span id="game-3-bet-display" class="font-bold text-white">0</span> DP. Elige tu destino:</p>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <button id="game-3-choice-heads" class="bet-button text-lg py-4">CARA</button>
                        <button id="game-3-choice-tails" class="bet-button text-lg py-4">CRUZ</button>
                    </div>
                </div>
                
                <div id="game-3-coin" class="hidden">?</div>
                
                <p id="game-3-feedback" class="text-center text-yellow-300 h-5 mt-4"></p>
            </div>
        </div>
        
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>Hecho para el seguimiento de tu duelo.</p>
        </footer>
    
    </div> <!-- Fin de #app-content -->

    <!-- TODO EL JAVASCRIPT EST AHORA AQU DENTRO -->
    <script type="module">
    
        // --- [INICIO] MDULO: main.js ---
        
        // --- IMPORTACIONES DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, setLogLevel, collection, doc, 
            onSnapshot, addDoc, setDoc, updateDoc, 
            getDocs, query, writeBatch 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // (Las importaciones de m贸dulos locales ya no son necesarias)
        
        // --- CONFIGURACIN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyABsmkXrhStMBi6517stczD0KcgVAPNm_A",
            authDomain: "torneo-duelistas-f535a.firebaseapp.com",
            projectId: "torneo-duelistas-f535a",
            storageBucket: "torneo-duelistas-f535a.firebasestorage.app",
            messagingSenderId: "701455896792",
            appId: "1:701455896792:web:667ec25f0defd7c98c87ad"
        };
                
        // --- VARIABLES GLOBALES ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); 

        let userId;
        let dbPlayersRef; 
        let dbHistoryRef; 
        let localPlayersCache = new Map();
        let loggedInPlayerId = null;

        const playerPasswords = {
            "Pepito": "pepe",
            "Prometeus": "falerini",
            "Rela": "itachikun10"
        };
        const TOTAL_GAMES = 3; // Reducido de 6 a 3
        const DAILY_PLAY_LIMIT = 3;

        // (Ya no se necesita el bloque 'export')

        // --- DOM ELEMENTS (MAIN) ---
        const userTableBody = document.getElementById('user-table-body');
        const historyList = document.getElementById('history-list');
        const rankingTableBody = document.getElementById('ranking-table-body');
        const loginScreen = document.getElementById('login-screen');
        const loginButton = document.getElementById('login-button');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginFeedback = document.getElementById('login-feedback');
        const dbLoadingFeedback = document.getElementById('db-loading-feedback');
        const appContent = document.getElementById('app-content');
        const loggedInUserDisplay = document.getElementById('logged-in-user-display');
        const packBuyerDisplay = document.getElementById('pack-buyer-display');
        const adminUnlockButton = document.getElementById('admin-unlock-button');
        const adminLockScreen = document.getElementById('admin-lock-screen');
        const purchaseFeedback = document.getElementById('purchase-feedback');
        const adminFeedback = document.getElementById('admin-feedback');
        const adminWeekFeedback = document.getElementById('admin-week-feedback');
        const packButtons = [
            document.getElementById('buy-pack-1'),
            document.getElementById('buy-pack-2'),
            document.getElementById('buy-pack-3'),
            document.getElementById('buy-pack-4'),
            document.getElementById('buy-pack-5'),
            document.getElementById('buy-pack-6')
        ];

        // --- AUTENTICACIN Y INICIALIZACIN ---

        async function initializeAppWithAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    
                    const basePath = `torneo/torneo-data`; 
                    dbPlayersRef = collection(db, `${basePath}/players`);
                    dbHistoryRef = collection(db, `${basePath}/history`);

                    await seedInitialData();
                    initPlayersListener();
                    initHistoryListener();
                    
                    dbLoadingFeedback.textContent = "隆Conexi贸n exitosa!";
                    dbLoadingFeedback.className = "text-green-400 text-sm h-5 text-center";
                    
                    // Iniciar los "m贸dulos" (ahora son solo funciones)
                    initStore();
                    initGames();
                    initAdmin();

                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error de autenticaci贸n:", error);
                        dbLoadingFeedback.textContent = "Error al conectar con la DB.";
                        dbLoadingFeedback.className = "text-red-400 text-sm h-5 text-center";
                    }
                }
            });
        }

        // --- ESTRUCTURA DE DATOS PARA JUEGOS ---
        function getInitialGamePlays() {
            let plays = {};
            for (let i = 1; i <= TOTAL_GAMES; i++) { // TOTAL_GAMES ahora es 3
                plays[`game_${i}`] = { count: 0, reset_timestamp: null };
            }
            return plays;
        }

        // --- LGICA DE DATOS INICIALES (SEEDING) ---
        async function seedInitialData() {
            const playerQuery = query(dbPlayersRef);
            const snapshot = await getDocs(playerQuery);
            if (snapshot.empty) {
                console.log("Base de datos vac铆a. Creando datos iniciales...");
                dbLoadingFeedback.textContent = "Creando base de datos inicial...";
                
                const initialGamePlays = getInitialGamePlays();
                const initialPlayers = [
                    { id: "Pepito", name: "Pepito", dp: 0, deck: "Yugi", wins_semanales: 0, card_collection: {}, game_plays: initialGamePlays },
                    { id: "Prometeus", name: "Prometeus", dp: 0, deck: "Joey", wins_semanales: 0, card_collection: {}, game_plays: initialGamePlays },
                    { id: "Rela", name: "Rela", dp: 0, deck: "Kaiba", wins_semanales: 0, card_collection: {}, game_plays: initialGamePlays }
                ];
                
                const initialHistory = []; 

                for (const player of initialPlayers) {
                    await setDoc(doc(dbPlayersRef, player.id), player);
                }
                for (const event of initialHistory) {
                    await addDoc(dbHistoryRef, event);
                }
            } else {
                console.log("Datos encontrados. Omitiendo creaci贸n inicial.");
            }
        }

        // --- RESETEO DE LMITES DE JUEGO ---
        async function checkAndResetGamePlays(player) {
            const now = Date.now();
            let plays = player.game_plays || getInitialGamePlays();
            let needsUpdate = false;

            for (let i = 1; i <= TOTAL_GAMES; i++) { // TOTAL_GAMES ahora es 3
                const gameId = `game_${i}`;
                const gameData = plays[gameId] || { count: 0, reset_timestamp: null };

                if (gameData.reset_timestamp && now > gameData.reset_timestamp) {
                    gameData.count = 0;
                    gameData.reset_timestamp = null;
                    plays[gameId] = gameData;
                    needsUpdate = true;
                }
            }

            if (needsUpdate) {
                console.log(`Reseteando juegos para ${player.name}`);
                try {
                    await updateDoc(doc(dbPlayersRef, player.id), { game_plays: plays });
                    player.game_plays = plays;
                    localPlayersCache.set(player.id, player);
                } catch (error) {
                    console.error("Error al resetear juegos:", error);
                }
            }
            return player; 
        }

        // --- LISTENERS (TIEMPO REAL) ---
        function initPlayersListener() {
            onSnapshot(dbPlayersRef, async (snapshot) => {
                const playerPromises = [];
                snapshot.forEach((doc) => {
                    const playerData = doc.data();
                    playerData.id = doc.id;
                    playerPromises.push(checkAndResetGamePlays(playerData));
                });
                
                const updatedPlayers = await Promise.all(playerPromises);
                localPlayersCache.clear();
                updatedPlayers.forEach(player => localPlayersCache.set(player.id, player));
                
                const players = Array.from(localPlayersCache.values());
                
                const sortedByDp = [...players].sort((a, b) => b.dp - a.dp);
                const sortedByWins = [...players].sort((a, b) => (b.wins_semanales || 0) - (a.wins_semanales || 0));

                // Actualizar UI
                updateUserTable(sortedByDp);
                updateRankingTable(sortedByWins);
                updateAdminDropdowns(players);
                
                if (loggedInPlayerId) {
                    updateGameButtonsUI();
                }
            });
        }

        function initHistoryListener() {
            onSnapshot(dbHistoryRef, (snapshot) => {
                const historyEvents = [];
                snapshot.forEach((doc) => {
                    historyEvents.push(doc.data());
                });
                historyEvents.sort((a, b) => b.timestamp - a.timestamp);
                historyList.innerHTML = '';

                if (historyEvents.length === 0) {
                    historyList.innerHTML = `<li class="bg-gray-700 p-3 rounded-lg text-center text-gray-400">No hay eventos en la historia.</li>`;
                    return;
                }

                historyEvents.forEach(event => {
                    const li = document.createElement('li');
                    const eventClasses = getHistoryEntryClass(event.type);
                    const date = new Date(event.timestamp).toLocaleString('es-ES', { timeStyle: 'short', dateStyle: 'short' });

                    li.className = `bg-gray-700 p-3 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center ${eventClasses.bg}`;
                    li.innerHTML = `
                        <span class="text-gray-400 text-sm w-full sm:w-1/4 mb-1 sm:mb-0">${date}</span>
                        <p class="w-full sm:w-3/4 ${eventClasses.text}">
                            ${event.text}
                        </p>
                    `;
                    historyList.appendChild(li);
                });
            });
        }

        // --- FUNCIONES DE ACTUALIZACIN DE UI (DOM) ---

        function updateUserTable(players) {
            userTableBody.innerHTML = '';
            if (players.length === 0) {
                userTableBody.innerHTML = `<tr><td colspan="3" class="px-4 py-4 text-center text-gray-400">Cargando jugadores...</td></tr>`;
                return;
            }
            players.forEach(player => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-700 transition duration-150";
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-lg font-semibold text-white">${player.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-2xl font-extrabold text-yellow-400 dp-score">${player.dp}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-400">${player.deck}</td>
                `;
                userTableBody.appendChild(row);
            });
        }

        function updateRankingTable(players) {
            rankingTableBody.innerHTML = '';
            if (players.length === 0) {
                rankingTableBody.innerHTML = `<tr><td colspan="3" class="px-4 py-4 text-center text-gray-400">Cargando ranking...</td></tr>`;
                return;
            }
            players.forEach((player, index) => {
                const rankRow = document.createElement('tr');
                rankRow.className = "hover:bg-gray-700 transition duration-150";
                rankRow.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-lg font-bold text-gray-300">${index + 1}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-lg font-semibold text-white">${player.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-2xl font-extrabold text-green-400">${player.wins_semanales || 0}</td>
                `;
                rankingTableBody.appendChild(rankRow);
            });
        }

        function updateAdminDropdowns(players) {
            const adminPlayerSelect = document.getElementById('admin-player-select');
            const adminPlayerSelectLoser = document.getElementById('admin-player-select-loser');
            const adminCardInventorySelect = document.getElementById('admin-card-inventory-select');
            
            adminPlayerSelect.innerHTML = '';
            adminPlayerSelectLoser.innerHTML = '';
            adminCardInventorySelect.innerHTML = '';

            if (players.length === 0) {
                [adminPlayerSelect, adminPlayerSelectLoser, adminCardInventorySelect].forEach(sel => {
                    sel.innerHTML = `<option>Cargando...</option>`;
                });
                return;
            }

            players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = `${player.name} (${player.dp} DP)`;
                
                const simpleOption = document.createElement('option');
                simpleOption.value = player.id;
                simpleOption.textContent = player.name;
                
                adminPlayerSelect.appendChild(option.cloneNode(true));
                adminPlayerSelectLoser.appendChild(option.cloneNode(true));
                adminCardInventorySelect.appendChild(simpleOption.cloneNode(true));
            });

            // Actualizar la vista de inventario
            const currentSelection = loggedInPlayerId || players[0].id;
            if(adminCardInventorySelect.querySelector(`option[value="${currentSelection}"]`)) {
                adminCardInventorySelect.value = currentSelection;
            }
            // Disparar manualmente el evento de cambio
            updateCardInventoryView(adminCardInventorySelect.value);
        }


        function updateGameButtonsUI() {
            if (!loggedInPlayerId) return;
            const player = localPlayersCache.get(loggedInPlayerId);
            if (!player) return;

            const plays = player.game_plays || getInitialGamePlays();
            const gameModals = {
                "game_1": { btnText: document.getElementById('game-1-button-text'), btn: document.getElementById('game-1-button') },
                "game_2": { btnText: document.getElementById('game-2-button-text'), btn: document.getElementById('game-2-button') },
                "game_3": { btnText: document.getElementById('game-3-button-text'), btn: document.getElementById('game-3-button') }
                // Juegos 4, 5, 6 eliminados
            };

            for (let i = 1; i <= TOTAL_GAMES; i++) { // TOTAL_GAMES ahora es 3
                const gameId = `game_${i}`;
                const gameData = plays[gameId] || { count: 0, reset_timestamp: null };
                const ui = gameModals[gameId];
                
                const playsLeft = DAILY_PLAY_LIMIT - gameData.count;
                ui.btnText.textContent = `Jugar (${playsLeft}/${DAILY_PLAY_LIMIT} Oportunidades)`;
                
                if (playsLeft <= 0) {
                    ui.btn.disabled = true;
                } else {
                    ui.btn.disabled = false;
                }
            }
        }

        // --- LGICA DE LOGIN ---
        function initLogin() {
            loginButton.addEventListener('click', () => {
                const usernameInput = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value;
                
                if (localPlayersCache.size === 0) {
                    loginFeedback.textContent = 'A煤n conectando con la base de datos...';
                    setTimeout(() => { loginFeedback.textContent = ''; }, 3000);
                    return;
                }

                let foundPlayer = null;
                for (const player of localPlayersCache.values()) {
                    if (player.name.toLowerCase() === usernameInput.toLowerCase()) {
                        foundPlayer = player;
                        break;
                    }
                }

                if (foundPlayer && playerPasswords[foundPlayer.name] === password) {
                    loggedInPlayerId = foundPlayer.name; 
                    appContent.classList.remove('hidden'); 
                    loginScreen.classList.add('hidden'); 
                    
                    loggedInUserDisplay.textContent = foundPlayer.name;
                    packBuyerDisplay.textContent = foundPlayer.name;
                    adminUnlockButton.disabled = false; 
                    adminLockScreen.querySelector('p.text-xs').classList.add('hidden'); 
                    
                    updateGameButtonsUI(); // Actualiza los botones de juego al loguear
                    
                } else {
                    loginFeedback.textContent = 'Usuario o contrase帽a incorrectos.';
                    setTimeout(() => { loginFeedback.textContent = ''; }, 3000);
                }
            });
            
            loginPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loginButton.click();
                }
            });
        }

        // --- FUNCIONES DE AYUDA (HELPERS) ---

        function getHistoryEntryClass(type) {
            switch(type) {
                case 'win': return { bg: 'border-l-4 border-green-500', text: 'text-green-300' };
                case 'buy': return { bg: 'border-l-4 border-blue-500', text: 'text-blue-300' };
                case 'admin': return { bg: 'border-l-4 border-indigo-500', text: 'text-indigo-300' };
                case 'penalty': return { bg: 'border-l-4 border-red-500', text: 'text-red-300' };
                case 'game_win': return { bg: 'border-l-4 border-pink-500', text: 'text-pink-300' };
                case 'game_lose': return { bg: 'border-l-4 border-gray-500', text: 'text-gray-300' };
                default: return { bg: '', text: 'text-gray-100' };
            }
        }

        function showFeedback(element, message, isError = false, duration = 3000) {
            element.textContent = message;
            element.className = isError 
                ? 'text-red-400 text-sm mt-2 h-5 feedback-message opacity-100 text-center' 
                : 'text-yellow-300 text-sm mt-2 h-5 feedback-message opacity-100 text-center';
            if(duration > 0) {
                setTimeout(() => {
                    element.style.opacity = '0';
                }, duration);
            }
        }

        function getGamePlays(gameId) {
            const player = localPlayersCache.get(loggedInPlayerId);
            if (!player) return { canPlay: false, reason: 'Jugador no encontrado.' }; // Guardia de seguridad
            
            const data = (player.game_plays && player.game_plays[gameId]) ? 
                         player.game_plays[gameId] : 
                         { count: 0, reset_timestamp: null };

            const now = Date.now();
            
            if (data.reset_timestamp && now < data.reset_timestamp && data.count >= DAILY_PLAY_LIMIT) {
                return { canPlay: false, reason: 'L铆mite diario alcanzado. Vuelve m谩s tarde.' };
            }
            
            return { canPlay: true, currentData: data };
        }

        async function recordGamePlay(gameId, currentData, dpChange, historyText, historyType) {
            const player = localPlayersCache.get(loggedInPlayerId);
            const now = Date.now();

            const newCount = currentData.count + 1;
            const newTimestamp = currentData.reset_timestamp || (now + 24 * 60 * 60 * 1000); 

            let newPlayData = { ...(player.game_plays || getInitialGamePlays()) };
            newPlayData[gameId] = { count: newCount, reset_timestamp: newTimestamp };
            
            const newDp = player.dp + dpChange;

            const playerRef = doc(dbPlayersRef, loggedInPlayerId);
            const historyDocRef = doc(collection(db, dbHistoryRef.path));
            
            const historyEntry = {
                text: historyText,
                timestamp: now,
                type: historyType
            };

            const batch = writeBatch(db);
            batch.update(playerRef, { dp: newDp, game_plays: newPlayData });
            batch.set(historyDocRef, historyEntry);
            
            await batch.commit();
        }

        // --- [FIN] MDULO: main.js ---


        // --- [INICIO] MDULO: store.js ---
        
        // (Las importaciones ya est谩n arriba)
        
        // --- DOM DE LA TIENDA ---
        const packOpeningModal = document.getElementById('pack-opening-modal');
        const modalClosePackButton = document.getElementById('modal-close-pack-button');
        const packCardList = document.getElementById('pack-card-list');

        // --- LISTA DE CARTAS DE LOS PACKS ---
        const customPacks = {
            // Pack 1: Poder del Mago (Yugi/Pegasus) - 150 DP
            "Poder del Mago": {
                cost: 150,
                cards: {
                    common: ["Dark Magician Girl", "Kuriboh", "Celtic Guardian", "Mammoth Graveyard", "Mystical Elf", "Feral Imp", "Book of Secret Arts", "Dark Hole", "Dian Keto the Cure Master", "Fissure", "Stop Defense", "Trap Hole", "Two-Pronged Attack"],
                    rare: ["Dark Magician", "Gaia The Fierce Knight", "Black Luster Soldier", "Magician of Black Chaos", "Polymerization", "Monster Reborn", "Swords of Revealing Light", "Mirror Force"],
                    superRare: ["Relinquished", "Black Illusion Ritual", "Thousand-Eyes Restrict"]
                },
                pullRates: {
                    // 5 cartas: 4 Comunes, 1 Rara
                    common: 4,
                    rare: 1,
                    superRare: 0 // SR solo por suerte
                },
                luck: { // 10% de que una Rara se vuelva SR
                    from: "rare",
                    to: "superRare",
                    rate: 0.1 
                }
            },
            // Pack 2: Furia del Drag贸n (Kaiba/Joey) - 150 DP
            "Furia del Drag贸n": {
                cost: 150,
                cards: {
                    common: ["Blue-Eyes White Dragon", "Hitotsu-Me Giant", "Rude Kaiser", "Kojikocy", "Saggi the Dark Clown", "Beaver Warrior", "Flame Swordsman", "Masaki the Legendary Swordsman", "Kunai with Chain", "Reinforcements", "Red-Eyes B. Dragon", "Gearfried the Iron Knight", "Axe Raider"],
                    rare: ["Vorse Raider", "Battle Ox", "La Jinn the Mystical Genie of the Lamp", "Polymerization", "Crush Card Virus", "Enemy Controller", "Red-Eyes Black Metal Dragon", "Time Wizard", "Scapegoat", "Metalmorph"],
                    superRare: ["XYZ-Dragon Cannon", "Blue-Eyes Ultimate Dragon", "Paladin of White Dragon"]
                },
                pullRates: {
                    common: 4,
                    rare: 1,
                    superRare: 0
                },
                luck: { // 10% de que una Rara se vuelva SR
                    from: "rare",
                    to: "superRare",
                    rate: 0.1 
                }
            },
            // Pack 3: Arsenal del Duelista (Staples) - 300 DP
            "Arsenal del Duelista": {
                cost: 300,
                cards: {
                    common: ["Fissure", "Dark Hole", "De-Spell", "Stop Defense", "Trap Hole", "Remove Trap", "Mystical Space Typhoon", "Heavy Storm", "Giant Trunade", "Nobleman of Crossout"],
                    rare: ["Book of Moon", "Swords of Revealing Light", "Monster Reborn", "Change of Heart", "Pot of Greed", "Graceful Charity", "Harpie's Feather Duster"],
                    superRare: ["Raigeki", "Mirror Force", "Magic Cylinder", "Call of the Haunted", "Torrential Tribute", "Imperial Order"]
                },
                pullRates: {
                    // 5 cartas: 3 Comunes, 1 Rara, 1 SR Garantizada
                    common: 3,
                    rare: 1,
                    superRare: 1
                }
            },
            // PACK 4: Tesoro del Fara贸n - 500 DP
            "Tesoro del Fara贸n": {
                cost: 500,
                cards: {
                    common: ["Gravekeeper's Spy", "Gravekeeper's Guard", "Gravekeeper's Spear Soldier", "Mystical Tomato", "Spirit Reaper", "Mask of Darkness", "Magician of Faith"],
                    rare: ["Gravekeeper's Chief", "Gravekeeper's Visionary", "Necrovalley", "Royal Tribute", "Pot of Avarice"],
                    superRare: ["Exodia the Forbidden One", "Left Arm of the Forbidden One", "Right Arm of the Forbidden One", "Left Leg of the Forbidden One", "Right Leg of the Forbidden One", "Jinzo"]
                },
                pullRates: {
                    common: 4,
                    rare: 1,
                    superRare: 0
                },
                luck: { // 10% de que una Rara se vuelva SR
                    from: "rare",
                    to: "superRare",
                    rate: 0.1
                }
            },
            // PACK 5: Legado del Ojo Azul - 1000 DP
            "Legado del Ojo Azul": {
                cost: 1000,
                cards: {
                    common: ["Vorse Raider", "X-Head Cannon", "Y-Dragon Head", "Z-Metal Tank", "Cyber Jar", "Sangan", "Witch of the Black Forest"],
                    rare: ["Blue-Eyes White Dragon", "Kaibaman", "Cyber Dragon", "Crush Card Virus", "Enemy Controller", "Shrink", "Ring of Destruction"],
                    superRare: ["Blue-Eyes Ultimate Dragon", "XYZ-Dragon Cannon", "Chaos Emperor Dragon - Envoy of the End", "Cyber End Dragon"]
                },
                pullRates: {
                    // 7 cartas: 4 Comunes, 1 Rara, 2 SR Garantizadas
                    common: 4,
                    rare: 1,
                    superRare: 2
                }
            },
            // PACK 6: El Cofre Prohibido - 1500 DP
            "El Cofre Prohibido": {
                cost: 1500,
                cards: {
                    // No hay comunes
                    rare: ["Book of Moon", "Nobleman of Crossout", "Pot of Greed", "Graceful Charity", "Change of Heart", "Monster Reborn", "Harpie's Feather Duster", "Sangan", "Witch of the Black Forest"],
                    superRare: ["Raigeki", "Mirror Force", "Magic Cylinder", "Call of the Haunted", "Torrential Tribute", "Imperial Order", "Jinzo", "Exodia the Forbidden One", "Left Arm of the Forbidden One", "Right Arm of the Forbidden One", "Left Leg of the Forbidden One", "Right Leg of the Forbidden One"],
                    ultraRare: ["Chaos Emperor Dragon - Envoy of the End", "Black Luster Soldier - Envoy of the Beginning", "Dark Magician of Chaos", "Blue-Eyes Shining Dragon"]
                },
                pullRates: {
                    // 7 cartas: 4 Raras, 2 S煤per Raras, 1 Ultra Rara
                    common: 0,
                    rare: 4,
                    superRare: 2,
                    ultraRare: 1
                }
            }
        };

        // --- LGICA DE LA TIENDA ---

        // Funci贸n para inicializar la tienda
        function initStore() {
            packButtons.forEach(button => {
                button.addEventListener('click', handlePackPurchase);
            });
            modalClosePackButton.addEventListener('click', closePackModal);
        }

        // Manejador de la compra de packs
        async function handlePackPurchase(event) {
            if (!loggedInPlayerId) {
                showFeedback(purchaseFeedback, "Debes iniciar sesi贸n para comprar", true);
                return;
            }

            const button = event.currentTarget;
            const packName = button.dataset.name;
            const packCost = parseInt(button.dataset.cost);
            const packData = customPacks[packName];
            
            const player = localPlayersCache.get(loggedInPlayerId);
            if (!player) {
                showFeedback(purchaseFeedback, "Error: No se encontr贸 al jugador", true);
                return;
            }

            if (player.dp < packCost) {
                showFeedback(purchaseFeedback, `DP insuficientes. Necesitas ${packCost} DP.`, true);
                return;
            }

            // Deshabilitar botones para evitar doble compra
            packButtons.forEach(btn => btn.disabled = true);
            showFeedback(purchaseFeedback, `Procesando compra de ${packName}...`, false, 0);

            try {
                const pulledCards = openPack(packData);
                
                // Actualizar la base de datos
                await updatePlayerInventory(player, packCost, pulledCards, packName);
                
                // Mostrar el modal con las cartas
                showPackOpeningModal(pulledCards);
                
                showFeedback(purchaseFeedback, `隆${packName} comprado exitosamente!`, false);

            } catch (error) {
                console.error("Error al comprar pack:", error);
                showFeedback(purchaseFeedback, "Error al procesar la compra.", true);
            } finally {
                // Los botones se rehabilitar谩n autom谩ticamente por el listener
            }
        }

        // Funci贸n para abrir un pack y determinar las cartas
        function openPack(packData) {
            const pulledCards = [];
            const { cards, pullRates, luck } = packData;

            // L贸gica para sacar cartas
            Object.entries(pullRates).forEach(([rarity, count]) => {
                for (let i = 0; i < count; i++) {
                    if (cards[rarity] && cards[rarity].length > 0) {
                        let card = cards[rarity][Math.floor(Math.random() * cards[rarity].length)];
                        
                        // L贸gica de suerte (reemplazo)
                        if (luck && luck.from === rarity && Math.random() < luck.rate) {
                            const luckyRarity = luck.to;
                            if (cards[luckyRarity] && cards[luckyRarity].length > 0) {
                                card = cards[luckyRarity][Math.floor(Math.random() * cards[luckyRarity].length)];
                            }
                        }
                        pulledCards.push(card);
                    }
                }
            });
            return pulledCards;
        }

        // Funci贸n para actualizar el inventario y DP del jugador en Firestore
        async function updatePlayerInventory(player, packCost, pulledCards, packName) {
            const newDp = player.dp - packCost;
            const newCollection = { ...player.card_collection };

            pulledCards.forEach(card => {
                newCollection[card] = (newCollection[card] || 0) + 1;
            });

            const playerRef = doc(dbPlayersRef, player.id);
            const historyDocRef = doc(collection(db, dbHistoryRef.path));
            
            const historyEntry = {
                text: `${player.name} compr贸 un pack "${packName}" por ${packCost} DP.`,
                timestamp: Date.now(),
                type: 'buy'
            };

            const batch = writeBatch(db);
            batch.update(playerRef, { dp: newDp, card_collection: newCollection });
            batch.set(historyDocRef, historyEntry);
            
            await batch.commit();
        }

        // Funciones del modal de apertura de pack
        function showPackOpeningModal(cards) {
            packCardList.innerHTML = ''; // Limpiar lista anterior
            cards.forEach(card => {
                const li = document.createElement('li');
                li.className = "text-lg text-yellow-200 font-medium";
                li.textContent = card;
                packCardList.appendChild(li);
            });
            
            packOpeningModal.classList.remove('hidden', 'opacity-0', 'visibility-hidden');
        }

        function closePackModal() {
            packOpeningModal.classList.add('opacity-0', 'visibility-hidden');
            setTimeout(() => {
                packOpeningModal.classList.add('hidden');
            }, 300); // Esperar a que la transici贸n termine
        }
        
        // --- [FIN] MDULO: store.js ---


        // --- [INICIO] MDULO: games.js ---
        
        // (Las importaciones ya est谩n arriba)

        // --- VARIABLES GLOBALES DE JUEGOS ---
        let currentGame = 0;
        let currentBet = 0;
        let isGameInProgress = false;
        let gameModalClosers = {};

        // --- DOM DE JUEGOS ---
        const gameModals = {
            1: document.getElementById('game-1-modal'),
            2: document.getElementById('game-2-modal'),
            3: document.getElementById('game-3-modal')
            // Juegos 4, 5, 6 eliminados
        };

        const gameOpeners = {
            1: document.getElementById('open-game-1'),
            2: document.getElementById('open-game-2'),
            3: document.getElementById('open-game-3')
            // Juegos 4, 5, 6 eliminados
        };

        // --- FUNCIN DE INICIALIZACIN ---
        function initGames() {
            Object.entries(gameOpeners).forEach(([id, opener]) => {
                opener.addEventListener('click', () => openGameModal(parseInt(id)));
            });

            // Inicializar listeners espec铆ficos de cada juego
            initGame1();
            initGame2();
            initGame3();
            // initGame4, 5, 6 eliminados
        }

        // --- LGICA DE MODAL (ABRIR/CERRAR) ---

        function openGameModal(gameId) {
            const player = localPlayersCache.get(loggedInPlayerId);
            if (!player) return;

            // Comprobar si puede jugar
            const playCheck = getGamePlays(`game_${gameId}`);
            if (!playCheck.canPlay) {
                console.warn(playCheck.reason);
                return;
            }

            currentGame = gameId;
            isGameInProgress = false;
            currentBet = 0;

            const modal = gameModals[gameId];
            if (modal) {
                resetGameModal(gameId); // Resetear el estado visual del modal
                modal.classList.remove('hidden', 'opacity-0', 'visibility-hidden');
            }
        }

        function closeGameModal(gameId) {
            if (isGameInProgress) return; // No cerrar si el juego est谩 en marcha
            
            const modal = gameModals[gameId];
            if (modal) {
                modal.classList.add('opacity-0', 'visibility-hidden');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
            currentGame = 0;
            currentBet = 0;
        }

        function resetGameModal(gameId) {
            const modal = gameModals[gameId];
            if (!modal) return;

            // Resetear botones de apuesta
            modal.querySelectorAll('.bet-button').forEach(btn => btn.classList.remove('selected'));
            
            // Ocultar pasos secundarios, mostrar paso 1
            modal.querySelector(`[id^="game-${gameId}-step-1"]`).style.display = 'block';
            const step2 = modal.querySelector(`[id^=game-${gameId}-step-2]`);
            if(step2) step2.style.display = 'none';

            // Resetear feedback
            const feedback = modal.querySelector(`[id^="game-${gameId}-feedback"]`);
            if(feedback) feedback.textContent = '';
            
            // Reseteos espec铆ficos de cada juego
            switch(gameId) {
                case 1:
                    modal.querySelector('#game-1-grid').classList.add('opacity-50', 'pointer-events-none');
                    modal.querySelectorAll('.bet-card').forEach(card => {
                        card.classList.remove('is-flipped', 'chosen');
                        const back = card.querySelector('.card-back');
                        back.classList.remove('win', 'lose');
                        back.textContent = '';
                    });
                    break;
                case 2:
                    modal.querySelector('#game-2-dice-1').textContent = '?';
                    modal.querySelector('#game-2-dice-2').textContent = '?';
                    modal.querySelectorAll('[id^="game-2-choice-"]').forEach(btn => btn.disabled = false);
                    break;
                case 3:
                    modal.querySelector('#game-3-coin').classList.add('hidden');
                    modal.querySelector('#game-3-coin').textContent = '?';
                    modal.querySelectorAll('[id^="game-3-choice-"]').forEach(btn => btn.disabled = false);
                    break;
                // Casos 4, 5, 6 eliminados
            }
        }

        // --- LGICA DE APUESTAS (COMPARTIDA) ---
        function selectBet(gameId, betAmount, betButton) {
            if (isGameInProgress) return;
            
            const player = localPlayersCache.get(loggedInPlayerId);
            if (player.dp < betAmount) {
                const feedback = gameModals[gameId].querySelector(`[id^="game-${gameId}-feedback"]`);
                showFeedback(feedback, "No tienes suficientes DP para esta apuesta.", true);
                return;
            }
            
            currentBet = betAmount;
            
            // Actualizar UI de botones de apuesta
            const modal = gameModals[gameId];
            modal.querySelectorAll('.bet-button').forEach(btn => btn.classList.remove('selected'));
            betButton.classList.add('selected');
            
            // Ocultar paso 1, mostrar paso 2
            modal.querySelector(`[id^="game-${gameId}-step-1"]`).style.display = 'none';
            const step2 = modal.querySelector(`[id^="game-${gameId}-step-2"]`);
            if(step2) step2.style.display = 'block';

            // L贸gica espec铆fica post-apuesta
            switch(gameId) {
                case 1:
                    modal.querySelector('#game-1-grid').classList.remove('opacity-50', 'pointer-events-none');
                    break;
                case 2:
                    modal.querySelector('#game-2-bet-display').textContent = betAmount;
                    break;
                case 3:
                    modal.querySelector('#game-3-bet-display').textContent = betAmount;
                    break;
                // Casos 4, 5, 6 eliminados
            }
        }

        // --- JUEGO 1: ETERNALS BETCARDS ---
        function initGame1() {
            const modal = gameModals[1];
            gameModalClosers[1] = modal.querySelector('#game-1-close-button');
            gameModalClosers[1].addEventListener('click', () => closeGameModal(1));

            // Listeners de apuestas
            modal.querySelector('#game-1-bet-options').addEventListener('click', e => {
                if (e.target.classList.contains('bet-button')) {
                    selectBet(1, parseInt(e.target.dataset.bet), e.target);
                }
            });

            // Listeners de cartas
            modal.querySelector('#game-1-grid').addEventListener('click', async e => {
                const card = e.target.closest('.bet-card');
                if (card && currentBet > 0 && !isGameInProgress) {
                    isGameInProgress = true;
                    await playGame1(card);
                }
            });
        }

        async function playGame1(chosenCard) {
            const modal = gameModals[1];
            const feedback = modal.querySelector('#game-1-feedback');
            const cards = modal.querySelectorAll('.bet-card');
            showFeedback(feedback, "Revelando...", false, 0);

            const playCheck = getGamePlays('game_1');
            if (!playCheck.canPlay) {
                showFeedback(feedback, playCheck.reason, true);
                isGameInProgress = false;
                return;
            }

            const winningIndex = Math.floor(Math.random() * 3);
            const chosenIndex = parseInt(chosenCard.dataset.index);
            let dpChange = -currentBet;
            let historyText = "";
            let historyType = "";

            if (chosenIndex === winningIndex) {
                // GAN
                const winnings = Math.floor(currentBet * 1.5);
                dpChange = winnings - currentBet;
                historyText = `${loggedInPlayerId} gan贸 ${dpChange} DP en Eternals BetCards (apost贸 ${currentBet}).`;
                historyType = 'game_win';
                showFeedback(feedback, `隆GANASTE! Recibes ${winnings} DP (+${dpChange} DP).`, false, 5000);
            } else {
                // PERDI
                historyText = `${loggedInPlayerId} perdi贸 ${currentBet} DP en Eternals BetCards.`;
                historyType = 'game_lose';
                showFeedback(feedback, `隆Mala suerte! Pierdes ${currentBet} DP.`, true, 5000);
            }

            // Voltear cartas
            cards.forEach((card, index) => {
                const back = card.querySelector('.card-back');
                if (index === winningIndex) {
                    back.classList.add('win');
                    back.textContent = 'GANADORA';
                } else {
                    back.classList.add('lose');
                    back.textContent = 'PIERDE';
                }
                if (index === chosenIndex) {
                    card.classList.add('chosen');
                }
                setTimeout(() => card.classList.add('is-flipped'), index * 100 + 300);
            });

            try {
                await recordGamePlay('game_1', playCheck.currentData, dpChange, historyText, historyType);
            } catch (e) {
                console.error(e);
                showFeedback(feedback, "Error al guardar el resultado.", true, 5000);
            }

            setTimeout(() => {
                closeGameModal(1);
            }, 5000);
        }


        // --- JUEGO 2: DUELO DE DADOS ---
        function initGame2() {
            const modal = gameModals[2];
            gameModalClosers[2] = modal.querySelector('#game-2-close-button');
            gameModalClosers[2].addEventListener('click', () => closeGameModal(2));

            modal.querySelector('#game-2-bet-options').addEventListener('click', e => {
                if (e.target.classList.contains('bet-button')) {
                    selectBet(2, parseInt(e.target.dataset.bet), e.target);
                }
            });

            modal.querySelector('#game-2-step-2').addEventListener('click', async e => {
                const choice = e.target.closest('.bet-button');
                if (choice && currentBet > 0 && !isGameInProgress) {
                    isGameInProgress = true;
                    let choiceType = '';
                    if (choice.id.includes('low')) choiceType = 'low';
                    if (choice.id.includes('seven')) choiceType = 'seven';
                    if (choice.id.includes('high')) choiceType = 'high';
                    
                    modal.querySelectorAll('[id^="game-2-choice-"]').forEach(btn => btn.disabled = true);
                    await playGame2(choiceType);
                }
            });
        }

        async function playGame2(choice) {
            const modal = gameModals[2];
            const feedback = modal.querySelector('#game-2-feedback');
            const dice1El = modal.querySelector('#game-2-dice-1');
            const dice2El = modal.querySelector('#game-2-dice-2');
            
            showFeedback(feedback, "Lanzando dados...", false, 0);

            const playCheck = getGamePlays('game_2');
            if (!playCheck.canPlay) {
                showFeedback(feedback, playCheck.reason, true);
                isGameInProgress = false;
                return;
            }

            // Simulaci贸n de lanzamiento
            let animInterval = setInterval(() => {
                dice1El.textContent = Math.floor(Math.random() * 6) + 1;
                dice2El.textContent = Math.floor(Math.random() * 6) + 1;
            }, 100);

            setTimeout(async () => {
                clearInterval(animInterval);
                
                const d1 = Math.floor(Math.random() * 6) + 1;
                const d2 = Math.floor(Math.random() * 6) + 1;
                const total = d1 + d2;
                dice1El.textContent = d1;
                dice2El.textContent = d2;

                let resultType = '';
                if (total < 7) resultType = 'low';
                if (total === 7) resultType = 'seven';
                if (total > 7) resultType = 'high';

                let dpChange = -currentBet;
                let historyText = "";
                let historyType = "";
                let winnings = 0;

                if (choice === resultType) {
                    // GAN
                    const multiplier = (choice === 'seven') ? 5 : 2;
                    winnings = currentBet * multiplier;
                    dpChange = winnings - currentBet;
                    historyText = `${loggedInPlayerId} gan贸 ${dpChange} DP en Duelo de Dados (apost贸 ${currentBet} al ${total}).`;
                    historyType = 'game_win';
                    showFeedback(feedback, `隆GANASTE! Sali贸 ${total}. Recibes ${winnings} DP (+${dpChange} DP).`, false, 5000);
                } else {
                    // PERDI
                    historyText = `${loggedInPlayerId} perdi贸 ${currentBet} DP en Duelo de Dados (sali贸 ${total}).`;
                    historyType = 'game_lose';
                    showFeedback(feedback, `隆Mala suerte! Sali贸 ${total}. Pierdes ${currentBet} DP.`, true, 5000);
                }

                try {
                    await recordGamePlay('game_2', playCheck.currentData, dpChange, historyText, historyType);
                } catch (e) {
                    console.error(e);
                    showFeedback(feedback, "Error al guardar el resultado.", true, 5000);
                }

                setTimeout(() => {
                    closeGameModal(2);
                }, 5000);

            }, 2000); // Duraci贸n de la animaci贸n
        }

        // --- JUEGO 3: MONEDA DEL MILENIO ---
        function initGame3() {
            const modal = gameModals[3];
            gameModalClosers[3] = modal.querySelector('#game-3-close-button');
            gameModalClosers[3].addEventListener('click', () => closeGameModal(3));

            modal.querySelector('#game-3-bet-options').addEventListener('click', e => {
                if (e.target.classList.contains('bet-button')) {
                    selectBet(3, parseInt(e.target.dataset.bet), e.target);
                }
            });

            modal.querySelector('#game-3-step-2').addEventListener('click', async e => {
                const choice = e.target.closest('.bet-button');
                if (choice && currentBet > 0 && !isGameInProgress) {
                    isGameInProgress = true;
                    let choiceType = choice.id.includes('heads') ? 'CARA' : 'CRUZ';
                    modal.querySelectorAll('[id^="game-3-choice-"]').forEach(btn => btn.disabled = true);
                    await playGame3(choiceType);
                }
            });
        }

        async function playGame3(choice) {
            const modal = gameModals[3];
            const feedback = modal.querySelector('#game-3-feedback');
            const coinEl = modal.querySelector('#game-3-coin');
            
            showFeedback(feedback, "Lanzando moneda...", false, 0);
            coinEl.classList.remove('hidden');
            coinEl.style.transition = 'transform 0.5s';

            const playCheck = getGamePlays('game_3');
            if (!playCheck.canPlay) {
                showFeedback(feedback, playCheck.reason, true);
                isGameInProgress = false;
                return;
            }

            // Animaci贸n de giro
            let flips = 0;
            let animInterval = setInterval(() => {
                coinEl.style.transform = `rotateY(${flips * 180}deg)`;
                coinEl.textContent = (flips % 2 === 0) ? "CARA" : "CRUZ";
                flips++;
            }, 150);

            setTimeout(async () => {
                clearInterval(animInterval);
                
                const result = Math.random() < 0.5 ? 'CARA' : 'CRUZ';
                coinEl.style.transform = (result === 'CARA') ? `rotateY(720deg)` : `rotateY(900deg)`; // Asegura que termine en el lado correcto
                coinEl.textContent = result;

                let dpChange = -currentBet;
                let historyText = "";
                let historyType = "";
                let winnings = 0;

                if (choice === result) {
                    // GAN
                    winnings = Math.floor(currentBet * 1.9); // 1.9x
                    dpChange = winnings - currentBet;
                    historyText = `${loggedInPlayerId} gan贸 ${dpChange} DP en Moneda del Milenio (apost贸 ${currentBet}).`;
                    historyType = 'game_win';
                    showFeedback(feedback, `隆GANASTE! Sali贸 ${result}. Recibes ${winnings} DP (+${dpChange} DP).`, false, 5000);
                } else {
                    // PERDI
                    historyText = `${loggedInPlayerId} perdi贸 ${currentBet} DP en Moneda del Milenio (sali贸 ${result}).`;
                    historyType = 'game_lose';
                    showFeedback(feedback, `隆Mala suerte! Sali贸 ${result}. Pierdes ${currentBet} DP.`, true, 5000);
                }

                try {
                    await recordGamePlay('game_3', playCheck.currentData, dpChange, historyText, historyType);
                } catch (e) {
                    console.error(e);
                    showFeedback(feedback, "Error al guardar el resultado.", true, 5000);
                }

                setTimeout(() => {
                    closeGameModal(3);
                }, 5000);

            }, 2000); // Duraci贸n de la animaci贸n
        }

        // (Todas las funciones de los juegos 4, 5, 6 han sido eliminadas)
        
        // --- [FIN] MDULO: games.js ---


        // --- [INICIO] MDULO: admin.js ---
        
        // (Las importaciones ya est谩n arriba)

        // --- DOM DEL ADMIN ---
        const adminLockScreen_admin = document.getElementById('admin-lock-screen'); // Renombrado para evitar colisi贸n
        const adminPasswordInput = document.getElementById('admin-password');
        const adminUnlockButton_admin = document.getElementById('admin-unlock-button'); // Renombrado
        const adminLockFeedback = document.getElementById('admin-lock-feedback');
        const adminContent = document.getElementById('admin-content');

        const adminPlayerSelect = document.getElementById('admin-player-select');
        const adminPlayerSelectLoser = document.getElementById('admin-player-select-loser');
        const adminSurrenderCheckbox = document.getElementById('admin-surrender-checkbox');
        const adminFlawlessCheckbox = document.getElementById('admin-flawless-checkbox');
        const adminSubmitButton = document.getElementById('admin-submit-button');

        const adminNewPlayerName = document.getElementById('admin-new-player-name');
        const adminNewPlayerDeck = document.getElementById('admin-new-player-deck');
        const adminAddPlayerButton = document.getElementById('admin-add-player-button');

        const adminResetWeekButton = document.getElementById('admin-reset-week-button');

        const adminCardInventorySelect = document.getElementById('admin-card-inventory-select');
        const adminCardInventoryList = document.getElementById('admin-card-inventory-list');

        // --- CONSTANTES DEL ADMIN ---
        const ADMIN_PASSWORD = "as17sa71";

        // --- FUNCIN DE INICIALIZACIN ---
        function initAdmin() {
            adminUnlockButton_admin.addEventListener('click', unlockAdminPanel);
            adminPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') adminUnlockButton_admin.click();
            });
            
            adminSubmitButton.addEventListener('click', registerDuel);
            adminAddPlayerButton.addEventListener('click', addNewPlayer);
            adminResetWeekButton.addEventListener('click', resetWeeklyRanking);
            
            adminCardInventorySelect.addEventListener('change', (e) => {
                updateCardInventoryView(e.target.value);
            });
            
            // Listener customizado para actualizar el inventario cuando cambien los dropdowns
            // (Esto se maneja ahora desde updateAdminDropdowns en main)
        }

        // --- LGICA DEL PANEL DE ADMIN ---

        function unlockAdminPanel() {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminLockScreen_admin.classList.add('hidden');
                adminContent.classList.remove('hidden');
            } else {
                adminLockFeedback.textContent = "Contrase帽a incorrecta.";
                setTimeout(() => { adminLockFeedback.textContent = ''; }, 3000);
            }
        }

        async function registerDuel() {
            const winnerId = adminPlayerSelect.value;
            const loserId = adminPlayerSelectLoser.value;

            if (winnerId === loserId) {
                showFeedback(adminFeedback, "El ganador y el perdedor no pueden ser la misma persona.", true);
                return;
            }

            const winner = localPlayersCache.get(winnerId);
            const loser = localPlayersCache.get(loserId);

            if (!winner || !loser) {
                showFeedback(adminFeedback, "Error al encontrar jugadores.", true);
                return;
            }

            let winnerDpGain = 100; // Victoria base
            let loserDpLoss = 0;
            let historyText = `Duelo registrado: ${winner.name} venci贸 a ${loser.name}.`;
            
            const isSurrender = adminSurrenderCheckbox.checked;
            const isFlawless = adminFlawlessCheckbox.checked;

            if (isSurrender) {
                winnerDpGain += 50;
                loserDpLoss = -50;
                historyText += ` (Perdedor se rindi贸: -50 DP).`;
            }
            if (isFlawless) {
                winnerDpGain += 100;
                historyText += ` (Victoria Flawless: +100 DP).`;
            }

            const newWinnerDp = winner.dp + winnerDpGain;
            const newLoserDp = Math.max(0, loser.dp + loserDpLoss); // Evitar DP negativos
            const newWinnerWins = (winner.wins_semanales || 0) + 1;

            const winnerRef = doc(dbPlayersRef, winnerId);
            const loserRef = doc(dbPlayersRef, loserId);
            const historyDocRef = doc(collection(db, dbHistoryRef.path));
            
            const historyEntry = {
                text: historyText,
                timestamp: Date.now(),
                type: 'win'
            };
            
            const penaltyHistoryEntry = {
                text: `${loser.name} perdi贸 50 DP por rendirse.`,
                timestamp: Date.now() + 1, // Asegurar orden
                type: 'penalty'
            };

            try {
                const batch = writeBatch(db);
                batch.update(winnerRef, { dp: newWinnerDp, wins_semanales: newWinnerWins });
                batch.update(loserRef, { dp: newLoserDp });
                batch.set(historyDocRef, historyEntry);
                
                if (isSurrender) {
                    batch.set(doc(collection(db, dbHistoryRef.path)), penaltyHistoryEntry);
                }
                
                await batch.commit();
                
                showFeedback(adminFeedback, "Duelo registrado con 茅xito.", false);
                adminSurrenderCheckbox.checked = false;
                adminFlawlessCheckbox.checked = false;
                
            } catch (error) {
                console.error("Error al registrar duelo:", error);
                showFeedback(adminFeedback, "Error al guardar el duelo.", true);
            }
        }

        async function addNewPlayer() {
            const newName = adminNewPlayerName.value.trim();
            const newDeck = adminNewPlayerDeck.value;

            if (!newName) {
                showFeedback(adminFeedback, "El nombre no puede estar vac铆o.", true);
                return;
            }

            // Verificar si el jugador ya existe
            if (localPlayersCache.has(newName) || Array.from(localPlayersCache.values()).some(p => p.name.toLowerCase() === newName.toLowerCase())) {
                showFeedback(adminFeedback, "Ese nombre de jugador ya existe.", true);
                return;
            }

            const newPlayerData = {
                id: newName,
                name: newName,
                dp: 0,
                deck: newDeck,
                wins_semanales: 0,
                card_collection: {},
                game_plays: getInitialGamePlays()
            };

            try {
                await setDoc(doc(dbPlayersRef, newName), newPlayerData);
                
                const historyEntry = {
                    text: `${newName} se ha unido al torneo con el deck de ${newDeck}.`,
                    timestamp: Date.now(),
                    type: 'admin'
                };
                await addDoc(dbHistoryRef, historyEntry);

                showFeedback(adminFeedback, `Jugador "${newName}" a帽adido con 茅xito.`, false);
                adminNewPlayerName.value = '';
                
            } catch (error) {
                console.error("Error al a帽adir jugador:", error);
                showFeedback(adminFeedback, "Error al a帽adir jugador.", true);
            }
        }

        async function resetWeeklyRanking() {
            showFeedback(adminWeekFeedback, "Reseteando ranking semanal...", false, 0);

            const players = Array.from(localPlayersCache.values());
            if (players.length === 0) {
                showFeedback(adminWeekFeedback, "No hay jugadores para resetear.", true);
                return;
            }

            // Encontrar al ganador
            const sortedByWins = [...players].sort((a, b) => (b.wins_semanales || 0) - (a.wins_semanales || 0));
            const winner = sortedByWins[0];
            
            if (!winner || (winner.wins_semanales || 0) === 0) {
                showFeedback(adminWeekFeedback, "Nadie gan贸 esta semana. Reseteando...", false);
            }

            try {
                const batch = writeBatch(db);
                
                // Resetear victorias de todos
                players.forEach(player => {
                    const playerRef = doc(dbPlayersRef, player.id);
                    batch.update(playerRef, { wins_semanales: 0 });
                });
                
                // A帽adir evento a la historia
                const historyText = (winner && (winner.wins_semanales || 0) > 0)
                    ? `隆Fin de la semana! El ganador es ${winner.name} con ${winner.wins_semanales} victorias. El ranking ha sido reseteado.`
                    : `Fin de la semana. Nadie gan贸 esta semana. El ranking ha sido reseteado.`;
                    
                const historyEntry = {
                    text: historyText,
                    timestamp: Date.now(),
                    type: 'admin'
                };
                batch.set(doc(collection(db, dbHistoryRef.path)), historyEntry);
                
                await batch.commit();
                showFeedback(adminWeekFeedback, "Ranking semanal reseteado con 茅xito.", false);
                
            } catch (error) {
                console.error("Error al resetear ranking:", error);
                showFeedback(adminWeekFeedback, "Error al resetear el ranking.", true);
            }
        }

        function updateCardInventoryView(playerId) {
            const player = localPlayersCache.get(playerId);
            if (!player) {
                adminCardInventoryList.innerHTML = `<li class="text-gray-400">Jugador no encontrado.</li>`;
                return;
            }
            
            const collection = player.card_collection;
            if (!collection || Object.keys(collection).length === 0) {
                adminCardInventoryList.innerHTML = `<li class="text-gray-400">${player.name} no tiene cartas.</li>`;
                return;
            }

            adminCardInventoryList.innerHTML = '';
            
            // Ordenar cartas alfab茅ticamente
            const sortedCards = Object.keys(collection).sort();
            
            sortedCards.forEach(cardName => {
                const count = collection[cardName];
                const li = document.createElement('li');
                li.className = "text-gray-200 flex justify-between";
                li.innerHTML = `
                    <span>${cardName}</span>
                    <span class="font-bold text-yellow-300">x${count}</span>
                `;
                adminCardInventoryList.appendChild(li);
            });
        }
        // --- [FIN] MDULO: admin.js ---
        
        
        // --- INICIAR LA APLICACIN ---
        initLogin();
        initializeAppWithAuth();

    </script>
    
</body>
</html>

